# HMM 기반 레짐 트레이딩 규칙 v2 (K=3: Up / Range / Down, Student-t + Rolling)

> 목적: 코인/선물에서 **Hidden Markov Model(HMM)** 로 시장 레짐을 추정하고, 레짐에 따라 **전략 ON/OFF + 방향 + 포지션 사이징 + 리스크 파라미터**를 스위칭한다.  
> 원칙: 레짐은 “진입 신호”가 아니라 **메타-필터/리스크 스위치**로 사용한다.

---

## 1. 레짐 정의 (Hidden States, K=3)

- **S1: Trend Up (상승 추세)**
- **S2: Range / Choppy (횡보/찢김)**
- **S3: Trend Down (하락 추세)**

> 라벨 스위칭 방지: 학습 후 각 상태의 통계(드리프트/변동성/추세성)로 “Up/Range/Down”을 사후에 매핑한다.

---

## 2. 관측값(Features) 설계 (Observations)

시간축 바(예: 15m 또는 1h) 기준으로 아래 3축을 최소 구성으로 사용한다.

### 2.1 수익률/드리프트
- 수익률: `r_t = log(P_t / P_{t-1})`
- 드리프트 proxy(평활):  
  - `m_t = EMA(r_t, L_m)`

### 2.2 변동성(로그 변동성 권장)
- 실현변동성: `RV_t = sum_{i=1..L_v} r_{t-i}^2` (또는 ATR 대체 가능)
- 변동성 피처: `v_t = log(RV_t)` (분포 안정화)

### 2.3 추세성(Trendiness)
추세 vs 횡보 구분력을 높이는 핵심 축.
- 예시:
  - `s_t = |EMA(P, L1) - EMA(P, L2)| / ATR(L_s)`
  - (대체: ADX, 모멘텀/변동성 비율 등)

### 2.4 최종 관측 벡터
- `X_t = [m_t, v_t, s_t]`

### 2.5 권장 기본 세팅(바로 시작용)
- 타임프레임: **15m 또는 1h**
- 파라미터 예:
  - `m_t`: EMA(returns, 16)
  - `RV_t`: window 32
  - `s_t`: (EMA(Price,16)-EMA(Price,64))/ATR(32)

---

## 3. HMM 모델 구조

### 3.1 파라미터
- 초기분포: `π`
- 전이행렬: `A_ij = P(Z_t=j | Z_{t-1}=i)`
- 방출분포(상태별 관측분포): `p(x) = P(X_t=x | Z_t=k)`

---

## 3.2 방출분포: 상태별 다변량 Student-t (권장 고정)

코인/선물 관측(특히 수익률/변동성)은 fat-tail(급등락)이 강하므로,
방출분포를 **상태별 다변량 Student-t**로 고정한다.

### 3.2.1 다변량 Student-t 밀도(d-dimensional)

상태 k에 대해 파라미터는 `(μ_k, Σ_k, ν_k)`:

- 평균 벡터: `μ_k ∈ R^d`
- 스케일(양의정부호) 행렬: `Σ_k ∈ R^{d×d}`
- 자유도: `ν_k > 0` (tail 두께)

정의:

- `δ_tk = (x_t - μ_k)^T Σ_k^{-1} (x_t - μ_k)`  (Mahalanobis distance)

```
\[
t_d(x_t \,|\, \mu_k, \Sigma_k, \nu_k)
=
\frac{\Gamma\left(\frac{\nu_k + d}{2}\right)}
     {\Gamma\left(\frac{\nu_k}{2}\right)
      (\nu_k \pi)^{d/2}
      |\Sigma_k|^{1/2}}
\left(1 + \frac{\delta_{tk}}{\nu_k}\right)^{-\frac{\nu_k + d}{2}}
\]
```

> 실무 팁: 구현 난도를 낮추려면 `ν_k`를 상태별로 추정하기보다 **공통 상수(예: 6~10)** 로 고정해도 충분히 잘 동작한다.

### 3.2.2 “정규분포 혼합” 표현(구현용 트릭)

Student-t는 스케일 혼합 정규로 쓸 수 있다.

\[
u_{tk} \sim \mathrm{Gamma}\left(\frac{\nu_k}{2}, \frac{\nu_k}{2}\right),\quad
X_t\mid(Z_t=k, u_{tk}) \sim \mathcal N\left(\mu_k, \frac{\Sigma_k}{u_{tk}}\right)
\]

이 표현을 쓰면 EM 업데이트가 깔끔해진다.

---

## 3.3 전이행렬(A) 설계 원칙 (레짐 지속성)

레짐은 자주 바뀌지 않는다는 가정 강화:
- `A_kk` (잔류확률) **0.90~0.99** 권장
- Up ↔ Down **직접 점프 확률**은 낮게, 보통 Range를 거치도록 유도

예시 초기값(컨셉):
```
A ≈
[ 0.95  0.045 0.005 ]
[ 0.025 0.95  0.025 ]
[ 0.005 0.045 0.95  ]
```

---

## 4. 학습(Training) 파이프라인 (HMM + Student-t EM)

### 4.1 데이터/피처
1) 데이터 고정: 종목(예: BTCUSDT Perp), 타임프레임(15m/1h)  
2) 피처 생성: `X_t` 생성 + **robust scaling**(중앙값/IQR) 권장

### 4.2 초기화(중요)
- K-means/GMM으로 `X_t`를 3클러스터로 나눠 `μ_k, Σ_k` 초기값 생성
- `A`는 잔류 높게 초기화
- `ν_k`는 (권장) 공통 상수로 시작: `ν=8` 같은 값

### 4.3 학습(개요) — 수식/업데이트는 생략
- 학습은 HMM의 **Baum–Welch(EM)** 절차로 수행한다. (세부 업데이트 식은 이 문서에서 삭제)
- 방출분포는 상태별 다변량 **Student-t**를 사용한다.
- 자유도 `ν`는 추정하지 않고, **공통 상수로 6~10 중 하나로 고정**한다. (예: `ν=8`)

> 팁: `ν`를 상태별로 따로 두면 과적합/불안정성이 커질 수 있으므로, 첫 구현은 공통 상수 고정이 안전하다.




---

## 5. 실전 적용: Non-stationarity 대응 (Rolling window + Online filtering)

HMM은 (π, A, μ, Σ, ν)가 **시간에 따라 고정(stationary)** 라고 가정한다.  
코인/선물은 이 가정이 자주 깨지므로, **롤링 윈도우 재학습**과 결합한다.

### 5.1 Rolling window 재학습(Stationarity 회피)
- 윈도우 길이: `W` bars
- 재학습 주기: `S` bars (예: 하루 1회, 4시간 1회 등)

시점 t에서 사용할 파라미터는:
- `λ_t = Train( X_{t-W : t-1} )`  (미래 데이터 금지)

운영 루틴:
1) 매 S bars마다 `λ_t`를 **재학습(또는 warm-start)**  
2) 그 사이에는 `λ_t` 고정한 채 실시간 추론만 수행

권장(경험칙):
- 15m: `W=30~120일`, `S=1~24시간`
- 1h : `W=90~365일`, `S=1일`

> 중요한 포인트: **레짐 라벨(Up/Range/Down) 매핑 규칙**도 매 재학습마다 일관되게 적용해야 한다.

### 5.2 Online filtering (라이브에서의 레짐 확률)
백테스트/리서치에서 Forward-Backward로 얻는 `P(Z_t | X_{1:T})`는 미래를 봐서 “부드럽게” 되므로,
실거래에서는 **필터 확률(미래 미사용)** 을 사용한다:

- `p_t(k) = P(Z_t=k | X_{1:t}, λ_t)`  (one-sided)

Forward recursion:
- 초기: `α_1(k) = π_k * p(x_1 | k)`
- 재귀:
  - `α_t(k) = p(x_t | k) * Σ_j α_{t-1}(j) A_{jk}`
- 정규화:
  - `p_t(k) = α_t(k) / Σ_i α_t(i)`

> 레짐 스위칭/사이징은 **p_t(k)** 로 구동한다(look-ahead 방지).

---

## 6. 전략 스위칭 규칙 (핵심)

> 레짐 경계에서의 출렁임을 줄이기 위해 **히스테리시스 + 연속 bar 확인**을 사용한다.  
> 아래의 확률은 모두 `p_t(·)=P(Z_t|X_{1:t})` 기준(라이브 기준).

- `p_U = p_t(Up)`
- `p_R = p_t(Range)`
- `p_D = p_t(Down)`
- Trend 강도: `p_T = p_U + p_D`
- 방향성: `dir = p_U - p_D`

### 6.1 히스테리시스(권장)
- **Trend 모드 ON**: `p_T >= 0.65` 가 **연속 2개 bar**
- **Trend 모드 OFF**: `p_T <= 0.55` 가 **연속 2개 bar**
- **Range 모드 ON**: `p_R >= 0.60` 가 **연속 2개 bar**

### 6.2 레짐별 전략 매핑

#### A) Up 레짐 우세 (p_U 높음)
- **ON**: 추세추종 Long
- **OFF**: 역추세 숏 평균회귀
- **파라미터**:
  - 목표: 기본 2R, 강추세면 트레일링 비중↑
  - 손절: ATR 기반이면 약간 넓게(노이즈 스윙 허용), 대신 사이즈로 위험 통제

#### B) Range 레짐 우세 (p_R 높음)
- **ON**: 평균회귀(MR)
- **OFF**: 브레이크아웃 추세추종
- **파라미터**:
  - 목표: **1.0~1.5R**
  - 손절: 타이트
  - 빈도: 신호 엄격(과매매 방지)

#### C) Down 레짐 우세 (p_D 높음)
- Up의 대칭
- **ON**: 추세추종 Short
- **OFF**: 역추세 롱 평균회귀

---

## 7. 방향성/가중치 기반 운영 (Soft Switch)

### 7.1 Trend 모드일 때(권장 운영)
- 조건: `p_T >= 0.65` (히스테리시스 충족)
- 방향 가중치:
  - `w_long  = max(0, dir)`
  - `w_short = max(0, -dir)`

### 7.2 Range 모드일 때
- 조건: `p_R >= 0.60`
- MR 전략만 활성화

---

## 8. 포지션 사이징(레짐 확률 → 리스크 변환)

기본 리스크 `r0`(예: 계좌 대비 0.25%~0.5%)를 두고,
레짐 확신에 따라 0~1 스케일로 조절한다.

- Trend 전략 위험:
  - `risk_trend = r0 * clip((p_T - 0.55) / 0.25, 0, 1)`
- MR 전략 위험:
  - `risk_mr = r0 * clip((p_R - 0.50) / 0.30, 0, 1)`

---

## 9. 레짐 전환 시 포지션 처리 룰

- 새 레짐이 **반대 방향**이면 해당 방향 신규 진입 금지
- 기존 포지션:
  - 이익 중: 트레일링 강화 + 빠른 청산 옵션
  - 손실 중: 원래 손절 유지(감정적 물타기 금지)
- (옵션) Trend → Range 전환 후 `p_R >= 0.70`이면 추세 포지션 청산 고려

---

## 10. 안전장치(코인/선물 필수)

- 변동성 급등(Vol Spike) 필터:
  - `v_t`가 상위 95% 구간이면 Trend 사이즈 축소, MR은 보수적으로 OFF 고려
- 이벤트/발표 시간대 필터(가능하면):
  - 대형 이벤트 구간: MR OFF, Trend도 축소(슬리피지/급변동 리스크)

---

## 11. 검증(Validation) 체크리스트

- 레짐별 통계가 유의미하게 분리되는가
- 레짐 평균 체류시간이 상식적인가(너무 자주 바뀌면 실패)
- OOS에서 레짐 특성이 유지되는가
- 거래비용/슬리피지 반영 후에도 기대값이 개선되는가

---

## 12. 운용 요약(한 장)

- 방출분포: **상태별 다변량 Student-t**
- 실거래 확률: `p_t(k)=P(Z_t=k | X_{1:t})` (필터링)
- Non-stationarity 대응: `λ_t = Train(X_{t-W:t-1})` (롤링 재학습, warm-start 권장)
- Trend ON: `p_U+p_D >= 0.65`(2 bars), 방향 `dir=p_U-p_D`
- Range ON: `p_R >= 0.60`(2 bars)
- Trend 모드: Trend 전략만(방향 가중치), Range 모드: MR 전략만
- 사이징: 레짐 확신에 따라 위험 자동 축소
